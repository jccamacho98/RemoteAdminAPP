{% extends "base.html" %}

{% block content %}
<h1>Instalación de Software</h1>

<!-- Formulario para cargar el instalador y seleccionar opciones -->
{% if online_pcs %}
<form method="post" enctype="multipart/form-data" id="install-form">
    {% csrf_token %}
    <div style="margin-bottom: 15px;">
        <h3>Fuente del archivo:</h3>
        <div style="display: flex; align-items: center; gap: 5px;">
            <input type="radio" id="source_upload" name="source_type" value="upload" checked onchange="updateSourceSelection()">
            <label for="source_upload">Subir archivo</label>
        </div>
        <div style="display: flex; align-items: center; gap: 5px;">
            <input type="radio" id="source_server" name="source_type" value="server" onchange="updateSourceSelection()">
            <label for="source_server">Seleccionar desde el servidor</label>
        </div>
    </div>

    <div style="margin-bottom: 15px;" id="upload_file_section">
        <label for="installer_file">Seleccionar instalador:</label><br>
        <input type="file" id="installer_file" name="installer_file" accept=".exe,.msi">
    </div>

    <div style="margin-bottom: 15px; display: none;" id="server_file_section">
        <label for="server_file">Seleccionar instalador desde el servidor:</label><br>
        <select id="server_file" name="server_file">
            <option value="">-- Seleccione un archivo --</option>
            <optgroup label="Instalación desatendida" id="unattended_files">
                {% for file in unattended_software_files %}
                <option value="{{ file }}">{{ file }}</option>
                {% endfor %}
            </optgroup>
            <optgroup label="Instalación atendida" id="attended_files">
                {% for file in attended_software_files %}
                <option value="{{ file }}">{{ file }}</option>
                {% endfor %}
            </optgroup>
        </select>
    </div>

    <div style="margin-bottom: 15px;" id="install_type_section">
        <h3>Tipo de instalación:</h3>
        <div style="display: flex; align-items: center; gap: 5px;">
            <input type="radio" id="unattended" name="install_type" value="unattended" checked>
            <label for="unattended">Instalación desatendida (silenciosa)</label>
        </div>
        <div style="display: flex; align-items: center; gap: 5px;">
            <input type="radio" id="attended" name="install_type" value="attended">
            <label for="attended">Instalación atendida (interactiva)</label>
        </div>
    </div>
    
    <div style="margin-bottom: 15px;">
        <h3>Seleccionar PCs ({{ online_pcs.count }} Online):</h3>
        <div class="select-all-item">
            <input type="checkbox" id="select_all" onclick="toggleSelectAll()">
            <label for="select_all">Seleccionar todos</label>
        </div>
        <div class="pc-selector" style="margin-top: 10px; max-height: 200px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; width: 300px;">
            {% for pc in online_pcs %}
            <div class="pc-item">
                <input type="checkbox" name="selected_pcs" value="{{ pc.nombre }}" id="pc_{{ pc.nombre }}" class="pc-checkbox">
                <label for="pc_{{ pc.nombre }}">{{ pc.nombre }}</label>
            </div>
            {% endfor %}
        </div>
        <p id="attended-warning" style="display: none; color: red;">
            Advertencia: La instalación interactiva solo permite seleccionar un PC a la vez.
        </p>
    </div>
    <button type="submit" name="install_software">Instalar Software</button>
</form>
{% else %}
<p>No hay PCs en línea disponibles para realizar la instalación de software.</p>
{% endif %}

<!-- Mostrar resultados -->
{% if output %}
<h2>Resultado:</h2>
<pre>{{ output }}</pre>
{% endif %}

<!-- Mostrar advertencia y opción de RDP si es instalación interactiva -->
{% if show_rdp_prompt %}
<div style="border: 1px solid #ffcc00; padding: 10px; background-color: #fff3cd; color: #856404;">
    <h3>Advertencia: Instalación interactiva seleccionada</h3>
    <p>Para continuar con la instalación interactiva en {{ rdp_pc_name }}, debes iniciar una sesión de Escritorio Remoto.</p>
    <p>El instalador está listo en: <strong>{{ installer_path }}</strong></p>
    <p>¿Deseas iniciar una sesión de Escritorio Remoto en {{ rdp_pc_name }} ahora?</p>
    <form method="post" id="rdp-form">
        {% csrf_token %}
        <input type="hidden" name="pc_name" value="{{ rdp_pc_name }}">
        <button type="submit" name="start_rdp">Sí</button>
        <button type="button" onclick="window.location.reload();">No</button>
    </form>
</div>
{% endif %}

<!-- Script para disparar RDP -->
{% if trigger_rdp and request.session.rdp_triggered %}
<script>
    fetch(`http://localhost:8080/trigger_rdp/{{ trigger_rdp }}`)
        .then(response => response.text())
        .then(data => {
            console.log(data);
        })
        .catch(error => {
            console.error('Error al disparar RDP:', error);
        });
</script>
{% endif %}

<!-- JavaScript para manejar la selección de PCs, fuente y la validación -->
<script>
function toggleSelectAll() {
    var selectAllCheckbox = document.getElementById('select_all');
    var pcCheckboxes = document.getElementsByClassName('pc-checkbox');
    for (var i = 0; i < pcCheckboxes.length; i++) {
        pcCheckboxes[i].checked = selectAllCheckbox.checked;
    }
    updateAttendedWarning();
}

function updateSourceSelection() {
    const sourceUpload = document.getElementById('source_upload');
    const uploadSection = document.getElementById('upload_file_section');
    const serverSection = document.getElementById('server_file_section');
    const installTypeSection = document.getElementById('install_type_section');
    const installerFileInput = document.getElementById('installer_file');
    const serverFileSelect = document.getElementById('server_file');

    if (sourceUpload.checked) {
        uploadSection.style.display = 'block';
        serverSection.style.display = 'none';
        installTypeSection.style.display = 'block';
        installerFileInput.setAttribute('required', 'required');
        serverFileSelect.removeAttribute('required');
    } else {
        uploadSection.style.display = 'none';
        serverSection.style.display = 'block';
        installTypeSection.style.display = 'none';
        installerFileInput.removeAttribute('required');
        serverFileSelect.setAttribute('required', 'required');
    }
}

document.addEventListener('DOMContentLoaded', function () {
    const installForm = document.getElementById('install-form');
    const installTypeAttended = document.getElementById('attended');
    const installTypeUnattended = document.getElementById('unattended');
    const pcCheckboxes = document.getElementsByClassName('pc-checkbox');
    const attendedWarning = document.getElementById('attended-warning');
    const sourceUpload = document.getElementById('source_upload');
    const sourceServer = document.getElementById('source_server');
    const installerFileInput = document.getElementById('installer_file');
    const serverFileSelect = document.getElementById('server_file');

    // Inicializar la visibilidad de las secciones
    updateSourceSelection();

    // Función para actualizar la advertencia de instalación interactiva
    function updateAttendedWarning() {
        if (installTypeAttended.checked && sourceUpload.checked) {
            const selectedCount = Array.from(pcCheckboxes).filter(cb => cb.checked).length;
            if (selectedCount > 1) {
                attendedWarning.style.display = 'block';
                // Deseleccionar todos los checkboxes excepto el primero seleccionado
                let firstSelected = null;
                for (let i = 0; i < pcCheckboxes.length; i++) {
                    if (pcCheckboxes[i].checked) {
                        if (!firstSelected) {
                            firstSelected = pcCheckboxes[i];
                        } else {
                            pcCheckboxes[i].checked = false;
                        }
                    }
                }
            } else {
                attendedWarning.style.display = 'none';
            }
        } else {
            attendedWarning.style.display = 'none';
        }
    }

    // Escuchar cambios en el tipo de instalación
    installTypeAttended.addEventListener('change', updateAttendedWarning);
    installTypeUnattended.addEventListener('change', updateAttendedWarning);

    // Escuchar cambios en los checkboxes de PCs
    Array.from(pcCheckboxes).forEach(checkbox => {
        checkbox.addEventListener('change', function () {
            // Actualizar el estado de "Seleccionar todos"
            const allChecked = Array.from(pcCheckboxes).every(cb => cb.checked);
            document.getElementById('select_all').checked = allChecked;
            updateAttendedWarning();
        });
    });

    // Validar el formulario al enviarlo
    if (installForm) {
        installForm.addEventListener('submit', function (event) {
            const selectedCount = Array.from(pcCheckboxes).filter(cb => cb.checked).length;
            if (selectedCount === 0) {
                event.preventDefault();
                alert('Por favor, seleccione al menos un PC antes de realizar esta acción.');
                return;
            }

            if (installTypeAttended.checked && sourceUpload.checked && selectedCount > 1) {
                event.preventDefault();
                alert('La instalación interactiva solo permite seleccionar un PC a la vez.');
                return;
            }

            if (sourceUpload.checked) {
                if (!installerFileInput.files.length) {
                    event.preventDefault();
                    alert('Por favor, seleccione un archivo instalador.');
                    return;
                }
            } else {
                if (!serverFileSelect.value) {
                    event.preventDefault();
                    alert('Por favor, seleccione un archivo del servidor.');
                    return;
                }
            }
        });
    }
});
</script>

<!-- Estilos CSS -->
<style>
    .pc-selector {
        margin-top: 10px;
        max-height: 200px;
        overflow-y: auto;
        border: 1px solid #ccc;
        padding: 10px;
        width: 300px; /* Ancho del selector */
        position: relative; /* Posición relativa para ajustes */
        left: 0px; /* Posición horizontal */
        top: 0px; /* Posición vertical */
    }

    .pc-item {
        display: flex;
        align-items: center;
        margin-bottom: 5px;
    }

    .pc-item input[type="checkbox"] {
        margin-right: 8px; /* Espacio entre el checkbox y el nombre del PC */
    }

    .select-all-item {
        display: flex;
        align-items: center;
        margin-bottom: 10px; /* Espacio entre "Seleccionar todos" y la lista de PCs */
    }

    .select-all-item input[type="checkbox"] {
        margin-right: 8px; /* Espacio entre el checkbox y la etiqueta "Seleccionar todos" */
    }

    #server_file {
        width: 300px;
        padding: 5px;
    }
</style>
{% endblock %}