{% extends "base.html" %}

{% block content %}
<h1>Instalación de Software</h1>

<!-- Formulario para cargar el instalador y seleccionar opciones -->
<form method="post" enctype="multipart/form-data" id="install-form">
    {% csrf_token %}
    <div style="margin-bottom: 15px;">
        <label for="installer_file">Seleccionar instalador:</label><br>
        <input type="file" id="installer_file" name="installer_file" accept=".exe,.msi" required>
    </div>
    <div style="margin-bottom: 15px;">
        <h3>Tipo de instalación:</h3>
        <div>
            <input type="radio" id="unattended" name="install_type" value="unattended" checked>
            <label for="unattended">Instalación desatendida (silenciosa)</label>
        </div>
        <div>
            <input type="radio" id="attended" name="install_type" value="attended">
            <label for="attended">Instalación atendida (interactiva)</label>
        </div>
    </div>
    <div style="margin-bottom: 15px;">
        <h3>Seleccionar PCs:</h3>
        <div class="select-all-item">
            <input type="checkbox" id="select_all" onclick="toggleSelectAll()">
            <label for="select_all">Seleccionar todos</label>
        </div>
        <div class="pc-selector" style="margin-top: 10px; max-height: 200px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; width: 300px;">
            {% for pc in pcs %}
            <div class="pc-item">
                <input type="checkbox" name="selected_pcs" value="{{ pc.nombre }}" id="pc_{{ pc.nombre }}" class="pc-checkbox">
                <label for="pc_{{ pc.nombre }}">{{ pc.nombre }} ({{ pc.estado }})</label>
            </div>
            {% empty %}
            <p>No hay PCs disponibles.</p>
            {% endfor %}
        </div>
        <p id="attended-warning" style="display: none; color: red;">
            Advertencia: La instalación interactiva solo permite seleccionar un PC a la vez.
        </p>
    </div>
    <button type="submit" name="install_software">Instalar Software</button>
</form>

<!-- Mostrar resultados -->
{% if output %}
<h2>Resultado:</h2>
<pre>{{ output }}</pre>
{% endif %}

<!-- Mostrar advertencia y opción de RDP si es instalación interactiva -->
{% if show_rdp_prompt %}
<div style="border: 1px solid #ffcc00; padding: 10px; background-color: #fff3cd; color: #856404;">
    <h3>Advertencia: Instalación interactiva seleccionada</h3>
    <p>Para continuar con la instalación interactiva en {{ rdp_pc_name }}, debes iniciar una sesión de Escritorio Remoto.</p>
    <p>El instalador está listo en: <strong>{{ installer_path }}</strong></p>
    <p>¿Deseas iniciar una sesión de Escritorio Remoto en {{ rdp_pc_name }} ahora?</p>
    <form method="post">
        {% csrf_token %}
        <input type="hidden" name="pc_name" value="{{ rdp_pc_name }}">
        <button type="submit" name="start_rdp">Sí</button>
        <button type="button" onclick="window.location.reload();">No</button>
    </form>
</div>
{% endif %}

<!-- JavaScript para manejar la selección de PCs y la validación -->
<script>
function toggleSelectAll() {
    var selectAllCheckbox = document.getElementById('select_all');
    var pcCheckboxes = document.getElementsByClassName('pc-checkbox');
    for (var i = 0; i < pcCheckboxes.length; i++) {
        pcCheckboxes[i].checked = selectAllCheckbox.checked;
    }
    updateAttendedWarning();
}

document.addEventListener('DOMContentLoaded', function () {
    const installForm = document.getElementById('install-form');
    const installTypeAttended = document.getElementById('attended');
    const installTypeUnattended = document.getElementById('unattended');
    const pcCheckboxes = document.getElementsByClassName('pc-checkbox');
    const attendedWarning = document.getElementById('attended-warning');

    // Función para actualizar la advertencia de instalación interactiva
    function updateAttendedWarning() {
        if (installTypeAttended.checked) {
            const selectedCount = Array.from(pcCheckboxes).filter(cb => cb.checked).length;
            if (selectedCount > 1) {
                attendedWarning.style.display = 'block';
                // Deseleccionar todos los checkboxes excepto el primero seleccionado
                let firstSelected = null;
                for (let i = 0; i < pcCheckboxes.length; i++) {
                    if (pcCheckboxes[i].checked) {
                        if (!firstSelected) {
                            firstSelected = pcCheckboxes[i];
                        } else {
                            pcCheckboxes[i].checked = false;
                        }
                    }
                }
            } else {
                attendedWarning.style.display = 'none';
            }
        } else {
            attendedWarning.style.display = 'none';
        }
    }

    // Escuchar cambios en el tipo de instalación
    installTypeAttended.addEventListener('change', function () {
        updateAttendedWarning();
        // Si se selecciona instalación interactiva, deseleccionar todos los checkboxes excepto el primero
        if (this.checked) {
            const selectedCheckboxes = Array.from(pcCheckboxes).filter(cb => cb.checked);
            if (selectedCheckboxes.length > 1) {
                for (let i = 1; i < selectedCheckboxes.length; i++) {
                    selectedCheckboxes[i].checked = false;
                }
            }
        }
    });

    installTypeUnattended.addEventListener('change', updateAttendedWarning);

    // Escuchar cambios en los checkboxes de PCs
    Array.from(pcCheckboxes).forEach(checkbox => {
        checkbox.addEventListener('change', function () {
            // Actualizar el estado de "Seleccionar todos"
            const allChecked = Array.from(pcCheckboxes).every(cb => cb.checked);
            document.getElementById('select_all').checked = allChecked;
            updateAttendedWarning();
        });
    });

    // Validar el formulario al enviarlo
    installForm.addEventListener('submit', function (event) {
        const selectedCount = Array.from(pcCheckboxes).filter(cb => cb.checked).length;
        if (selectedCount === 0) {
            event.preventDefault();
            alert('Por favor, seleccione al menos un PC antes de realizar esta acción.');
        } else if (installTypeAttended.checked && selectedCount > 1) {
            event.preventDefault();
            alert('La instalación interactiva solo permite seleccionar un PC a la vez.');
        }
    });
});
</script>

<!-- Estilos CSS -->
<style>
    .pc-selector {
        margin-top: 10px;
        max-height: 200px;
        overflow-y: auto;
        border: 1px solid #ccc;
        padding: 10px;
        width: 300px; /* Ancho del selector */
        position: relative; /* Posición relativa para ajustes */
        left: 0px; /* Posición horizontal */
        top: 0px; /* Posición vertical */
    }

    .pc-item {
        display: flex;
        align-items: center;
        margin-bottom: 5px;
    }

    .pc-item input[type="checkbox"] {
        margin-right: 8px; /* Espacio entre el checkbox y el nombre del PC */
    }

    .select-all-item {
        display: flex;
        align-items: center;
        margin-bottom: 10px; /* Espacio entre "Seleccionar todos" y la lista de PCs */
    }

    .select-all-item input[type="checkbox"] {
        margin-right: 8px; /* Espacio entre el checkbox y la etiqueta "Seleccionar todos" */
    }
</style>
{% endblock %}